<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.permission.menu.mapper.MenuMapper">

    <!-- 菜单DTO结果映射 -->
    <resultMap id="MenuDTOMap" type="com.permission.menu.dto.MenuDTO">
        <id column="id" property="id"/>
        <result column="menu_name" property="menuName"/>
        <result column="menu_code" property="menuCode"/>
        <result column="menu_type" property="menuType"/>
        <result column="parent_id" property="parentId"/>
        <result column="path" property="path"/>
        <result column="component" property="component"/>
        <result column="icon" property="icon"/>
        <result column="permission" property="permission"/>
        <result column="status" property="status"/>
        <result column="visible" property="visible"/>
        <result column="keep_alive" property="keepAlive"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="remark" property="remark"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 查询菜单树 -->
    <select id="selectMenuTree" resultMap="MenuDTOMap">
        SELECT 
            id, menu_name, menu_code, menu_type, parent_id, path, component, 
            icon, permission, status, visible, keep_alive, sort_order, remark,
            created_at, updated_at
        FROM sys_menu
        WHERE deleted = 0
        <if test="query != null">
            <if test="query.keyword != null and query.keyword != ''">
                AND (menu_name LIKE CONCAT('%', #{query.keyword}, '%') 
                     OR menu_code LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
            <if test="query.menuType != null">
                AND menu_type = #{query.menuType}
            </if>
            <if test="query.status != null">
                AND status = #{query.status}
            </if>
            <if test="query.visible != null">
                AND visible = #{query.visible}
            </if>
            <if test="query.parentId != null">
                AND parent_id = #{query.parentId}
            </if>
        </if>
        ORDER BY sort_order ASC, created_at ASC
    </select>

    <!-- 根据菜单编码查询菜单 -->
    <select id="selectMenuByCode" resultMap="MenuDTOMap">
        SELECT 
            id, menu_name, menu_code, menu_type, parent_id, path, component, 
            icon, permission, status, visible, keep_alive, sort_order, remark,
            created_at, updated_at
        FROM sys_menu
        WHERE menu_code = #{menuCode} AND deleted = 0
        LIMIT 1
    </select>

    <!-- 根据父级ID查询子菜单 -->
    <select id="selectMenusByParentId" resultMap="MenuDTOMap">
        SELECT 
            id, menu_name, menu_code, menu_type, parent_id, path, component, 
            icon, permission, status, visible, keep_alive, sort_order, remark,
            created_at, updated_at
        FROM sys_menu
        WHERE parent_id = #{parentId} AND deleted = 0
        ORDER BY sort_order ASC, created_at ASC
    </select>

    <!-- 根据用户ID查询菜单 -->
    <select id="selectMenusByUserId" resultMap="MenuDTOMap">
        SELECT DISTINCT 
            m.id, m.menu_name, m.menu_code, m.menu_type, m.parent_id, m.path, 
            m.component, m.icon, m.permission, m.status, m.visible, m.keep_alive, 
            m.sort_order, m.remark, m.created_at, m.updated_at
        FROM sys_menu m
        INNER JOIN sys_role_permission rp ON m.permission = rp.permission_code
        INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId} 
            AND m.deleted = 0 
            AND m.status = 1 
            AND m.visible = 1
        ORDER BY m.sort_order ASC, m.created_at ASC
    </select>

    <!-- 根据角色ID查询菜单 -->
    <select id="selectMenusByRoleId" resultMap="MenuDTOMap">
        SELECT DISTINCT 
            m.id, m.menu_name, m.menu_code, m.menu_type, m.parent_id, m.path, 
            m.component, m.icon, m.permission, m.status, m.visible, m.keep_alive, 
            m.sort_order, m.remark, m.created_at, m.updated_at
        FROM sys_menu m
        INNER JOIN sys_role_permission rp ON m.permission = rp.permission_code
        WHERE rp.role_id = #{roleId} 
            AND m.deleted = 0 
            AND m.status = 1
        ORDER BY m.sort_order ASC, m.created_at ASC
    </select>

    <!-- 查询所有启用的菜单 -->
    <select id="selectEnabledMenus" resultMap="MenuDTOMap">
        SELECT 
            id, menu_name, menu_code, menu_type, parent_id, path, component, 
            icon, permission, status, visible, keep_alive, sort_order, remark,
            created_at, updated_at
        FROM sys_menu
        WHERE status = 1 AND deleted = 0
        ORDER BY sort_order ASC, created_at ASC
    </select>

    <!-- 根据用户ID查询权限标识 -->
    <select id="selectPermissionsByUserId" resultType="java.lang.String">
        SELECT DISTINCT m.permission
        FROM sys_menu m
        INNER JOIN sys_role_permission rp ON m.permission = rp.permission_code
        INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId} 
            AND m.deleted = 0 
            AND m.status = 1 
            AND m.permission IS NOT NULL 
            AND m.permission != ''
    </select>

</mapper>