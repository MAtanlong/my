<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.permission.auth.mapper.RoleMapper">
    
    <!-- 角色DTO结果映射 -->
    <resultMap id="RoleDTOMap" type="com.permission.auth.dto.RoleDTO">
        <id column="id" property="id"/>
        <result column="role_name" property="roleName"/>
        <result column="role_code" property="roleCode"/>
        <result column="description" property="description"/>
        <result column="status" property="status"/>
        <result column="sort" property="sort"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>
    
    <!-- 分页查询角色列表 -->
    <select id="selectRolePage" resultMap="RoleDTOMap">
        SELECT 
            r.id,
            r.role_name,
            r.role_code,
            r.description,
            r.status,
            r.sort,
            r.created_at,
            r.updated_at
        FROM sys_role r
        <where>
            <if test="query.keyword != null and query.keyword != ''">
                AND (
                    r.role_name LIKE CONCAT('%', #{query.keyword}, '%')
                    OR r.role_code LIKE CONCAT('%', #{query.keyword}, '%')
                )
            </if>
            <if test="query.status != null and query.status != ''">
                AND r.status = #{query.status}
            </if>
        </where>
        ORDER BY r.sort ASC, r.created_at DESC
    </select>
    
    <!-- 根据角色ID查询角色详情 -->
    <select id="selectRoleById" resultMap="RoleDTOMap">
        SELECT 
            r.id,
            r.role_name,
            r.role_code,
            r.description,
            r.status,
            r.sort,
            r.created_at,
            r.updated_at
        FROM sys_role r
        WHERE r.id = #{roleId}
    </select>
    
    <!-- 根据角色编码查询角色 -->
    <select id="selectByRoleCode" resultType="com.permission.auth.entity.Role">
        SELECT * FROM sys_role WHERE role_code = #{roleCode}
    </select>
    
    <!-- 根据用户ID查询角色列表 -->
    <select id="selectRolesByUserId" resultMap="RoleDTOMap">
        SELECT 
            r.id,
            r.role_name,
            r.role_code,
            r.description,
            r.status,
            r.sort,
            r.created_at,
            r.updated_at
        FROM sys_role r
        INNER JOIN sys_user_role ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
        AND r.status = 1
        ORDER BY r.sort ASC, r.created_at DESC
    </select>
    
    <!-- 查询所有启用的角色 -->
    <select id="selectEnabledRoles" resultMap="RoleDTOMap">
        SELECT 
            r.id,
            r.role_name,
            r.role_code,
            r.description,
            r.status,
            r.sort,
            r.created_at,
            r.updated_at
        FROM sys_role r
        WHERE r.status = 1
        ORDER BY r.sort ASC, r.created_at DESC
    </select>
    
</mapper>